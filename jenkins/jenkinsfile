pipeline {
  agent any
  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }
    stage('Unit Tests') {
      steps {
        sh 'pip install -r app/requirements.txt'
        sh 'pytest -q app/test_api.py'
      }
    }
    stage('Build Docker Image') {
      steps {
        sh 'docker build -t iris-fastapi:ci -f app/dockerfile app'
      }
    }
    stage('Smoke Test Container') {
      steps {
        sh 'docker run -d --name iris_test -p 9000:8000 -v $(pwd)/models:/app/models iris-fastapi:ci'
        sh 'sleep 3'
        sh 'curl -s -X POST "http://127.0.0.1:9000/predict" -H "Content-Type: application/json" -d \'{"inputs": [[5.1,3.5,1.4,0.2]]}\''
      }
      post {
        always {
          sh 'docker rm -f iris_test || true'
        }
      }
    }
  }
}
